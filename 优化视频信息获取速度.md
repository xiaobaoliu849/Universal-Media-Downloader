# 优化视频信息获取速度方案

## 当前问题分析

### 为什么慢？

你的应用使用了**多阶段探测策略**来应对不同网站的反爬虫机制：

1. **primary** 阶段（基础探测）
   - YouTube: 30秒超时，5次重试
   - Twitter: 40秒超时，4次重试
   
2. **youtube_no_restrict** 阶段（去掉 --no-playlist）
   - 30秒超时

3. **hardened** 阶段（强化参数）
   - 30秒超时 + 更多重试

4. **youtube_extended** 阶段（扩展策略）
   - 60秒超时，8次重试，3-7秒随机延迟

5. **youtube_v6** 阶段（IPv6 尝试）
   - 60秒超时

**总计可能耗时：30 + 30 + 30 + 60 + 60 = 210 秒（3.5 分钟）！**

### 实际观察

从你的日志看，每个阶段大约 2-4 秒就失败了（因为年龄限制），但代码会依次尝试所有阶段。

---

## 🚀 优化方案

### 方案 1：减少超时时间（推荐，简单有效）

在 `.env` 文件中添加快速模式配置：

```properties
# 快速模式：减少超时和重试次数
LUMINA_FAST_INFO=1
```

然后修改 `config.py` 添加快速模式支持。

### 方案 2：智能早期退出（最优）

检测到特定错误（如"需要登录"）时，立即跳过后续阶段。

### 方案 3：并行探测（高级）

同时运行多个策略，谁先成功用谁。

---

## 📝 具体实现

### 实现方案 1 + 2（推荐）

我将为你创建优化补丁，包括：

1. ✅ 添加快速模式环境变量
2. ✅ 智能错误检测（年龄限制/需要登录立即停止）
3. ✅ 减少不必要的重试
4. ✅ 优化超时时间

预期效果：
- 成功情况：2-5 秒（原来 3-8 秒）
- 失败情况：5-10 秒（原来 30-180 秒）

---

## ⚙️ 配置选项

### 环境变量说明

| 变量 | 默认值 | 快速模式 | 说明 |
|------|--------|----------|------|
| `INFO_SOCKET_TIMEOUT` | 30 | 15 | 单次请求超时（秒）|
| `INFO_EXTRACTOR_RETRIES` | 5 | 2 | 提取器重试次数 |
| `INFO_RETRY_SLEEP` | 3 | 1 | 重试间隔（秒）|
| `INFO_MAX_STAGES` | 5 | 2 | 最大尝试阶段数 |
| `LUMINA_FAST_INFO` | 0 | 1 | 启用快速模式 |

### 推荐配置（.env）

```properties
# 代理配置（必需）
LUMINA_PROXY=http://127.0.0.1:33210

# Cookies 配置
AUTO_UPDATE_COOKIES=False

# 快速信息获取模式（推荐开启）
LUMINA_FAST_INFO=1

# 可选：手动微调（不设置则使用快速模式默认值）
# INFO_SOCKET_TIMEOUT=15
# INFO_EXTRACTOR_RETRIES=2
# INFO_MAX_STAGES=2
```

---

## 🎯 优化效果对比

### 优化前
```
粘贴链接 → 等待 15-30 秒 → 显示信息
（失败情况可能等待 1-3 分钟）
```

### 优化后
```
粘贴链接 → 等待 2-5 秒 → 显示信息
（失败情况 5-10 秒内返回错误）
```

---

## ⚠️ 注意事项

1. **快速模式可能降低成功率**
   - 对于网络不稳定的情况，可能需要更多重试
   - 如果经常失败，可以关闭快速模式

2. **不同网站的差异**
   - YouTube: 快速模式效果明显
   - Twitter/X: 本身就慢，改善有限
   - 其他网站: 通常很快

3. **代理速度影响**
   - 如果代理本身很慢，优化效果有限
   - 建议使用速度快的代理节点

---

## 🔧 故障排查

### 如果开启快速模式后经常失败

1. 关闭快速模式：
   ```properties
   LUMINA_FAST_INFO=0
   ```

2. 或手动调整参数：
   ```properties
   LUMINA_FAST_INFO=1
   INFO_SOCKET_TIMEOUT=20  # 稍微增加超时
   INFO_EXTRACTOR_RETRIES=3  # 增加重试次数
   ```

### 如果仍然很慢

1. 检查代理速度：
   ```bash
   curl --proxy http://127.0.0.1:33210 -w "@-" -o /dev/null -s https://www.youtube.com <<< "time_total: %{time_total}s\n"
   ```

2. 尝试更换代理节点

3. 检查网络连接质量

---

## 📊 性能监控

优化后，日志会显示每个阶段的耗时：

```
[api_info] 运行阶段 primary: ... (2.3s)
[api_info] 阶段 primary 成功，跳过后续阶段
```

如果看到多个阶段都在运行，说明前面的阶段都失败了。

 # 视频封面图下载与嵌入技术方案
# 视频封面图下载技术方案
 
 ## 一、概述
 
本文档说明如何在流光下载器中实现视频封面图（缩略图/Thumbnail）的独立下载功能。
 
## 二、yt-dlp 封面下载参数
 
| 参数 | 功能 |
|------|------|
| `--write-thumbnail` | 下载最高质量封面图 |
| `--write-all-thumbnails` | 下载所有尺寸封面图 |
| `--convert-thumbnails FORMAT` | 转换格式(jpg/png/webp) |
 
## 三、实现方案
 
### 3.1 修改 Task 类 (tasks.py)
 
```python
@dataclass
class Task:
    # ... 现有字段 ...
    write_thumbnail: bool = False  # 新增：是否下载封面图
 ```
 
### 3.2 修改 build_args 函数 (tasks.py)
 
 ```python
def build_args(...) -> List[str]:
    # ... 现有代码 ...
    
    # 封面图下载
    if getattr(task, 'write_thumbnail', False):
        a += ['--write-thumbnail']
        a += ['--convert-thumbnails', 'jpg']
    
    # ... 后续代码 ...
```

### 3.3 修改 API 接口 (app.py)

```python
# /api/stream_task 添加参数
write_thumbnail = request.args.get('thumbnail', '0').lower() in ('1', 'true', 'yes')

task = tm.add_task(
    # ... 现有参数 ...
    write_thumbnail=write_thumbnail
)
```

### 3.4 前端 UI

```html
<label>
    <input type="checkbox" id="writeThumbnail"> 下载封面图
</label>
```

## 四、输出文件

封面图会保存在与视频相同的目录，文件名格式：
- `视频标题.jpg` (使用 --convert-thumbnails jpg)
- 或 `视频标题.webp` (原始格式)

## 五、YouTube 封面尺寸参考

| 名称 | 尺寸 |
|------|------|
| maxresdefault | 1280x720 |
| sddefault | 640x480 |
| hqdefault | 480x360 |

yt-dlp 默认下载最高质量的封面。

## 六、命令行测试

```bash
# 仅下载封面（不下载视频）
yt-dlp --skip-download --write-thumbnail --convert-thumbnails jpg -o "封面.%(ext)s" "URL"

# 下载视频同时下载封面
yt-dlp --write-thumbnail --convert-thumbnails jpg -o "视频.%(ext)s" "URL"
```

## 七、仅下载封面模式（可选扩展）

如果需要支持"只下载封面不下载视频"：

```python
# 新增 mode: 'thumbnail_only'
if task.mode == 'thumbnail_only':
    args = [self.ytdlp_path, '--skip-download', '--write-thumbnail', 
            '--convert-thumbnails', 'jpg', '-o', out_path_template]
    # ... cookies/proxy 等参数
    args.append(task.url)
```

这样用户可以选择：
- 下载视频 + 封面
- 仅下载封面

---

*文档创建日期: 2025-12-20*
*适用于: 流光下载器 v3.x*
